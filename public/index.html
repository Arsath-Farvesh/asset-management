<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Takhlees Asset Management System</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --takhlees-gold: #6b7280;
  --takhlees-blue: #1f2937;
  --takhlees-dark: #111827;
  --takhlees-light: #f9fafb;
  --takhlees-accent: #3b82f6;
  --takhlees-success: #10b981;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  font-family: 'Poppins', sans-serif;
  min-height: 100vh;
  padding-bottom: 40px;
}

.navbar-takhlees {
  background: linear-gradient(135deg, var(--takhlees-dark) 0%, var(--takhlees-blue) 100%);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  padding: 16px 0;
}

.navbar-brand {
  font-weight: 700;
  font-size: 20px;
  color: white !important;
  display: flex;
  align-items: center;
  gap: 12px;
}

.brand-logo-small {
  width: 40px;
  height: 40px;
  background: linear-gradient(135deg, var(--takhlees-gold) 0%, #D4AF37 100%);
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 4px 8px rgba(197, 165, 114, 0.3);
}

.brand-logo-small i {
  color: var(--takhlees-dark);
  font-size: 20px;
}

.brand-text {
  display: flex;
  flex-direction: column;
  line-height: 1.2;
}

.brand-text .main {
  font-size: 18px;
  font-weight: 700;
}

.brand-text .sub {
  font-size: 10px;
  opacity: 0.9;
  font-weight: 400;
  letter-spacing: 0.5px;
}

.navbar-nav .btn {
  border-radius: 8px;
  font-weight: 500;
  padding: 8px 16px;
  transition: all 0.3s;
}

.btn-gold {
  background: linear-gradient(135deg, var(--takhlees-gold) 0%, #D4AF37 100%);
  border: none;
  color: var(--takhlees-dark);
}

.btn-gold:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(197, 165, 114, 0.4);
  color: var(--takhlees-dark);
}

.btn-outline-gold {
  border: 2px solid var(--takhlees-gold);
  color: var(--takhlees-gold);
  background: transparent;
}

.btn-outline-gold:hover {
  background: var(--takhlees-gold);
  color: var(--takhlees-dark);
}

.welcome-user {
  color: var(--takhlees-gold);
  font-weight: 600;
  font-size: 14px;
}

.page-header {
  background: linear-gradient(135deg, var(--takhlees-dark) 0%, var(--takhlees-blue) 100%);
  color: white;
  padding: 40px 0;
  margin-bottom: 40px;
  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
}

.page-header h1 {
  font-weight: 700;
  font-size: 32px;
  margin-bottom: 10px;
}

.page-header p {
  font-size: 16px;
  opacity: 0.9;
  margin: 0;
}

.card-takhlees {
  border: none;
  border-radius: 16px;
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
  background: white;
  margin-bottom: 30px;
  transition: all 0.3s;
}

.card-takhlees:hover {
  transform: translateY(-4px);
  box-shadow: 0 12px 32px rgba(0, 0, 0, 0.12);
}

.card-header-takhlees {
  background: linear-gradient(135deg, rgba(197, 165, 114, 0.1) 0%, rgba(197, 165, 114, 0.05) 100%);
  border-bottom: 2px solid var(--takhlees-gold);
  padding: 20px 25px;
  border-radius: 16px 16px 0 0;
}

.card-header-takhlees h3 {
  color: var(--takhlees-dark);
  font-weight: 600;
  font-size: 20px;
  margin: 0;
}

.card-body-takhlees {
  padding: 30px 25px;
}

.form-label {
  color: var(--takhlees-dark);
  font-weight: 600;
  font-size: 14px;
  margin-bottom: 8px;
}

.required-field::after {
  content: "*";
  color: var(--takhlees-accent);
  margin-left: 4px;
}

.form-control, .form-select {
  border: 2px solid #e8e8e8;
  border-radius: 10px;
  padding: 12px 16px;
  font-size: 14px;
  transition: all 0.3s;
}

.form-control:focus, .form-select:focus {
  border-color: var(--takhlees-gold);
  box-shadow: 0 0 0 4px rgba(197, 165, 114, 0.1);
}

.input-group .btn {
  border-radius: 0 10px 10px 0;
}

.category-badge {
  background: linear-gradient(135deg, var(--takhlees-gold) 0%, #D4AF37 100%);
  color: var(--takhlees-dark);
  padding: 6px 14px;
  border-radius: 20px;
  font-size: 13px;
  font-weight: 600;
  display: inline-block;
}

.btn-primary {
  background: linear-gradient(135deg, var(--takhlees-blue) 0%, #005f73 100%);
  border: none;
  border-radius: 10px;
  padding: 12px 24px;
  font-weight: 600;
  transition: all 0.3s;
}

.btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(0, 48, 73, 0.3);
}

.btn-secondary {
  background: #6c757d;
  border: none;
  border-radius: 10px;
  padding: 12px 24px;
  font-weight: 600;
}

.qr-barcode {
  width: 100%;
  max-width: 160px;
  height: auto;
  min-height: 160px;
  margin: 0 auto;
  display: block;
  border: 3px solid var(--takhlees-gold);
  border-radius: 12px;
  padding: 8px;
  background: white;
  object-fit: contain;
}

.qr-barcode-container {
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 200px;
}

.success-alert {
  display: none;
  position: fixed;
  top: 90px;
  right: 20px;
  z-index: 1000;
  background: linear-gradient(135deg, var(--takhlees-success) 0%, #05c792 100%);
  border: none;
  border-radius: 12px;
  color: white;
  font-weight: 600;
  box-shadow: 0 8px 24px rgba(6, 167, 125, 0.3);
  animation: slideIn 0.5s ease-out, slideOut 0.5s ease-in 2.5s;
}

@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateX(100px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

@keyframes slideOut {
  from {
    opacity: 1;
    transform: translateX(0);
  }
  to {
    opacity: 0;
    transform: translateX(100px);
  }
}

.hidden-field {
  display: none !important;
}

.preview-section {
  background: linear-gradient(135deg, rgba(197, 165, 114, 0.05) 0%, rgba(197, 165, 114, 0.02) 100%);
  padding: 20px;
  border-radius: 12px;
  margin-top: 15px;
}

.preview-section h4 {
  color: var(--takhlees-dark);
  font-weight: 700;
  font-size: 22px;
  margin-bottom: 20px;
}

.preview-section p {
  color: #6c757d;
  font-size: 14px;
  margin-bottom: 10px;
}

.preview-section span {
  color: var(--takhlees-dark);
  font-weight: 600;
}

.loading-spinner {
  display: none;
}
</style>
<link rel="stylesheet" href="theme.css">
</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-takhlees">
  <div class="container-fluid">
    <a class="navbar-brand" href="#">
      <div class="brand-logo-small">
        <!-- <i class="bi bi-shield-check"></i> -->
      </div>
      <div class="brand-text">
        <span class="main">Takhlees</span>
        <span class="sub">ASSET MANAGEMENT SYSTEM</span>
      </div>
    </a>
    
    <div class="d-flex align-items-center gap-2 ms-auto">
      <a href="history.html" class="btn btn-gold btn-sm">
        <i class="bi bi-clock-history me-1"></i>History
      </a>
      <a href="qr-scan.html" class="btn btn-outline-gold btn-sm">
        <i class="bi bi-qr-code me-1"></i>Scan QR
      </a>
      <span id="welcomeText" class="welcome-user ms-3 d-none d-md-inline"></span>
      <button id="logoutBtn" class="btn btn-outline-light btn-sm">
        <i class="bi bi-box-arrow-right me-1"></i>Logout
      </button>
    </div>
  </div>
</nav>

<!-- Page Header -->
<div class="page-header">
  <div class="container text-center">
    <h1><i class="bi bi-plus-circle-fill me-3"></i>Asset Input Module</h1>
    <p>Add and manage assets for Takhlees Government Services</p>
  </div>
</div>

<!-- Main Content -->
<div class="container">
  <div class="row">
    <!-- Form Section -->
    <div class="col-lg-8">
      <div class="card-takhlees">
        <div class="card-header-takhlees">
          <h3><i class="bi bi-pencil-square me-2"></i>Asset Details</h3>
        </div>
        <div class="card-body-takhlees">
          <form id="asset-form">
            <div class="row mb-4">
              <div class="col-md-6" id="asset-category-col">
                <label for="asset-category" class="form-label required-field">Category</label>
                <div class="input-group">
                  <select class="form-select" id="asset-category" required>
                    <option value="">Select a category</option>
                    <option value="assets">Assets</option>
                    <option value="customer_details">Case Details</option>
                    <option value="depreciation_history">Depreciation History</option>
                    <option value="digital_media">Digital Media</option>
                    <option value="documents">Documents</option>
                    <option value="employees">Employees</option>
                    <option value="equipments_assets">Keys</option>
                    <option value="financial_assets">Financial Assets</option>
                    <option value="furniture">Furniture</option>
                    <option value="infrastructure">Infrastructure</option>
                    <option value="intellectual_property">Intellectual Property</option>
                    <option value="it_hardware">IT Hardware</option>
                    <option value="leased_assets">Leased Assets</option>
                    <option value="locations">Locations</option>
                    <option value="machinery_equipment">Machinery & Equipment</option>
                    <option value="maintenance_logs">Maintenance Logs</option>
                    <option value="real_estate">Real Estate</option>
                    <option value="software_license">Software License</option>
                    <option value="tools">Tools</option>
                    <option value="vehicles">Vehicles</option>
                  </select>
                  <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                    <i class="bi bi-three-dots-vertical"></i>
                  </button>
                  <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="#" id="clear-category"><i class="bi bi-x-circle me-2"></i>Clear</a></li>
                    <li><a class="dropdown-item" href="qr-scan.html"><i class="bi bi-qr-code me-2"></i>Scan QR</a></li>
                    <li><a class="dropdown-item" href="history.html"><i class="bi bi-clock-history me-2"></i>View History</a></li>
                  </ul>
                </div>
              </div>
              <div class="col-md-6" id="asset-name-col">
                <label for="asset-name" class="form-label required-field">Asset Name</label>
                <div id="asset-name-container">
                  <select class="form-select" id="asset-name" disabled required>
                    <option value="">Select a category first</option>
                  </select>
                </div>
              </div>
            </div>
            
            <!-- Case Details Section -->
            <div id="customer-details-section" style="display: none;">
              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="customer-name" class="form-label required-field">Customer Name</label>
                  <input type="text" class="form-control" id="customer-name" placeholder="Enter customer name">
                </div>
                <div class="col-md-6">
                  <label for="customer-phone" class="form-label required-field">Customer Phone</label>
                  <input type="tel" class="form-control" id="customer-phone" placeholder="+971 XX XXX XXXX">
                </div>
              </div>
              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="case-date" class="form-label required-field">Date</label>
                  <input type="date" class="form-control" id="case-date">
                </div>
                <div class="col-md-6">
                  <label for="case-number" class="form-label required-field">Case Number</label>
                  <input type="text" class="form-control" id="case-number" placeholder="Enter case number">
                </div>
              </div>
              <div class="row mb-3">
                <div class="col-md-12">
                  <label for="case-type" class="form-label required-field">Type of Case</label>
                  <input type="text" class="form-control" id="case-type" placeholder="e.g., Ejari Registration, Visa Application">
                </div>
              </div>
            </div>

            <!-- Standard Fields -->
            <div id="standard-fields">
              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="serial-number" class="form-label">Serial Number</label>
                  <input type="text" class="form-control" id="serial-number" placeholder="Enter serial number">
                </div>
                <div class="col-md-6">
                  <label for="employee-name" class="form-label">Assigned Employee</label>
                  <input type="text" class="form-control" id="employee-name" placeholder="Enter employee name">
                </div>
              </div>
              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="asset-location" class="form-label">Location</label>
                  <select class="form-select" id="asset-location">
                    <option value="">Select location</option>
                    <option value="EJARI">EJARI</option>
                    <option value="Finance Office">Finance Office</option>
                    <option value="Management Office">Management Office</option>
                    <option value="Private Notary">Private Notary</option>
                    <option value="RDC">RDC</option>
                    <option value="DDL">DDL</option>
                    <option value="__manual__">Manual entry</option>
                  </select>
                  <input type="text" class="form-control mt-2 d-none" id="asset-location-manual" placeholder="Enter location">
                </div>
              </div>
            </div>
            
            <div id="dynamic-fields"></div>
            
            <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-5">
              <button type="reset" class="btn btn-secondary">
                <i class="bi bi-arrow-counterclockwise me-2"></i>Reset Form
              </button>
              <button type="submit" class="btn btn-primary">
                <i class="bi bi-plus-circle-fill me-2"></i>Add Asset
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Preview Section -->
    <div class="col-lg-4">
      <div class="card-takhlees">
        <div class="card-header-takhlees">
          <h3><i class="bi bi-eye-fill me-2"></i>Asset Preview</h3>
        </div>
        <div class="card-body-takhlees text-center">
          <div class="preview-section">
            <h4 id="preview-name">Asset Name</h4>
            <p>Category: <span class="category-badge" id="preview-category">Not selected</span></p>
            <p id="preview-serial-row">Serial: <span id="preview-serial">N/A</span></p>
            <p id="preview-employee-row">Employee: <span id="preview-employee">N/A</span></p>
            <p id="preview-location-row">Location: <span id="preview-location">N/A</span></p>
            
            <div id="preview-customer-details" style="display: none;">
              <p>Customer: <span id="preview-customer-name">N/A</span></p>
              <p>Phone: <span id="preview-customer-phone">N/A</span></p>
              <p>Case #: <span id="preview-case-number">N/A</span></p>
              <p>Case Type: <span id="preview-case-type">N/A</span></p>
            </div>
            
            <div class="row mt-4 g-3">
              <div class="col-md-6 d-flex flex-column align-items-center">
                <h6 style="color: var(--takhlees-dark); font-weight: 600; margin-bottom: 12px; width: 100%;">QR Code</h6>
                <div class="qr-barcode-container">
                  <img id="preview-qr" class="qr-barcode" alt="QR Code" src="https://api.qrserver.com/v1/create-qr-code/?size=160x160&data=Takhlees">
                </div>
              </div>
              <div class="col-md-6 d-flex flex-column align-items-center">
                <h6 style="color: var(--takhlees-dark); font-weight: 600; margin-bottom: 12px; width: 100%;">Barcode</h6>
                <div class="qr-barcode-container">
                  <img id="preview-barcode" class="qr-barcode" alt="Barcode" src="https://bwipjs-api.metafloor.com/?bcid=code128&text=TAKHLEES&scale=2&height=50&includetext">
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="alert success-alert" role="alert" id="success-alert">
  <i class="bi bi-check-circle-fill me-2"></i>
  <strong>Success!</strong> Asset has been added successfully.
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", async () => {
    // Check authentication and get user info
    const authRes = await fetch("/check-auth", { credentials: "include" });
    const auth = await authRes.json();
    if (!auth.authenticated) {
        window.location.href = "/login.html";
    }

    // Display welcome message with username
    if (auth.user && auth.user.username) {
        const welcomeEl = document.getElementById("welcomeText");
        if (welcomeEl) {
            welcomeEl.textContent = `Welcome, ${auth.user.username}!`;
        }
    }

    document.getElementById("logoutBtn").addEventListener("click", async () => {
        await fetch("/logout", { method: "POST", credentials: "include" });
        window.location.href = "/login.html";
    });

    // --- Asset form JS ---
    const assetForm = document.getElementById('asset-form');
    const assetCategory = document.getElementById('asset-category');
    const assetNameCol = document.getElementById('asset-name-col');
    const assetNameContainer = document.getElementById('asset-name-container');
    const dynamicFields = document.getElementById('dynamic-fields');
    const successAlert = document.getElementById('success-alert');
    
    // Sections
    const customerDetailsSection = document.getElementById('customer-details-section');
    const standardFields = document.getElementById('standard-fields');
    
    // Standard fields
    const serialNumber = document.getElementById('serial-number');
    const employeeName = document.getElementById('employee-name');
    const locationInput = document.getElementById('asset-location');
    const locationManual = document.getElementById('asset-location-manual');
    
    // Customer fields
    const customerName = document.getElementById('customer-name');
    const customerPhone = document.getElementById('customer-phone');
    const caseDate = document.getElementById('case-date');
    const caseNumber = document.getElementById('case-number');
    const caseType = document.getElementById('case-type');

    // Preview elements
    const previewName = document.getElementById('preview-name');
    const previewCategory = document.getElementById('preview-category');
    const previewSerialRow = document.getElementById('preview-serial-row');
    const previewSerial = document.getElementById('preview-serial');
    const previewEmployeeRow = document.getElementById('preview-employee-row');
    const previewEmployee = document.getElementById('preview-employee');
    const previewLocationRow = document.getElementById('preview-location-row');
    const previewLocation = document.getElementById('preview-location');
    const previewCustomerDetails = document.getElementById('preview-customer-details');
    const previewCustomerName = document.getElementById('preview-customer-name');
    const previewCustomerPhone = document.getElementById('preview-customer-phone');
    const previewCaseNumber = document.getElementById('preview-case-number');
    const previewCaseType = document.getElementById('preview-case-type');
    const previewQr = document.getElementById('preview-qr');
    const previewBarcode = document.getElementById('preview-barcode');

    // Event listeners for live preview
    serialNumber.addEventListener('input', updatePreview);
    employeeName.addEventListener('input', updatePreview);
    locationInput.addEventListener('change', () => {
      updateLocationManualVisibility();
      updatePreview();
    });
    locationInput.addEventListener('input', updatePreview);
    locationManual.addEventListener('input', updatePreview);
    customerName.addEventListener('input', updatePreview);
    customerPhone.addEventListener('input', updatePreview);
    caseDate.addEventListener('input', updatePreview);
    caseNumber.addEventListener('input', updatePreview);
    caseType.addEventListener('input', updatePreview);

    const categoryAssets = {
        assets: ["Laptop","Printer","Projector","Scanner"],
      customer_details: [],
        depreciation_history: ["Laptop Depreciation","Vehicle Depreciation"],
        digital_media: ["Camera","Lighting Kit","Microphone","Tripod"],
        documents: ["Contract","Invoice","Policy Document"],
        employees: [],
        financial_assets: ["Bonds","Cash Reserve","Mutual Funds","Stocks"],
        furniture: ["Bookshelf","Conference Table","L-Shaped Table","Office Chair","Small Table"],
        infrastructure: ["Networking Equipment","Power Backup","Server Room"],
        intellectual_property: ["Copyright","Patent","Trademark"],
        it_hardware: ["Desktop PC","Keyboard","Laptop","Monitor","Mouse"],
        leased_assets: ["Leased Car","Leased Laptop","Leased Printer"],
        locations: ["Branch 1","Branch 2","Head Office","Warehouse"],
        machinery_equipment: ["CNC Machine","Drill Press","Forklift"],
        maintenance_logs: ["AC Service","Elevator Maintenance","Generator Check"],
        real_estate: ["Office Building","Shop","Warehouse"],
        software_license: ["Adobe Photoshop","Antivirus","ERP System","MS Office"],
        tools: ["Drill","Hammer","Screwdriver Set","Wrench"],
        vehicles: ["Motorbike","Pickup Truck","Sedan","SUV"]
    };

    const categoryFields = {
        assets: [
            { type: 'date', id: 'purchase_date', label: 'Purchase Date', placeholder: '' },
            { type: 'number', id: 'value', label: 'Value ($)', placeholder: 'Enter asset value' }
        ],
        employees: [
            { type: 'text', id: 'department', label: 'Department', placeholder: 'Enter department' },
            { type: 'text', id: 'position', label: 'Position', placeholder: 'Enter job position' }
        ],
        maintenance_logs: [
            { type: 'date', id: 'maintenance_date', label: 'Maintenance Date', placeholder: '' },
            { type: 'text', id: 'technician', label: 'Technician', placeholder: 'Technician name' }
        ],
        it_hardware: [
            { type: 'text', id: 'brand', label: 'Brand', placeholder: 'Device brand' },
            { type: 'text', id: 'model', label: 'Model', placeholder: 'Device model' }
        ],
        vehicles: [
            { type: 'text', id: 'make', label: 'Make', placeholder: 'Vehicle make' },
            { type: 'text', id: 'model', label: 'Model', placeholder: 'Vehicle model' },
            { type: 'text', id: 'year', label: 'Year', placeholder: 'Manufacturing year' }
        ],
        equipments_assets: [
          { type: 'date', id: 'date', label: 'Date', placeholder: 'Equip Assign Date' },
          { type: 'number', id: 'keys', label: 'Keys', placeholder: 'No of Quantity' }
        ]
    };

    function updateLocationManualVisibility() {
      if (locationInput.value === '__manual__') {
        locationManual.classList.remove('d-none');
      } else {
        locationManual.classList.add('d-none');
        locationManual.value = '';
      }
    }

    function getLocationValue() {
      if (locationInput.value === '__manual__') {
        return locationManual.value.trim();
      }
      return locationInput.value;
    }

    function updatePreview() {
        const category = assetCategory.value || 'Not selected';
        if (category === 'customer_details') {
          previewCategory.textContent = 'Case Details';
        } else if (category === 'equipments_assets') {
          previewCategory.textContent = 'Keys';
        } else {
          previewCategory.textContent = category;
        }

        if (category === 'customer_details') {
            // Case details preview
            const nameEl = document.getElementById('asset-name');
            const caseName = nameEl ? nameEl.value : '';
            const cName = customerName.value || 'Customer Name';
            const cPhone = customerPhone.value || 'N/A';
            const cDate = caseDate.value || 'N/A';
            const cNum = caseNumber.value || 'N/A';
            const cType = caseType.value || 'N/A';
            
            previewName.textContent = caseName || 'Case Name';
            previewCustomerName.textContent = cName;
            previewCustomerPhone.textContent = cPhone;
            previewCaseNumber.textContent = cNum;
            previewCaseType.textContent = cType;
            
            // Hide standard fields in preview, show case details
            previewSerialRow.style.display = 'none';
            previewEmployeeRow.style.display = 'none';
            previewLocationRow.style.display = 'none';
            previewCustomerDetails.style.display = 'block';
            
            // Generate QR with case data
            const qrData = encodeURIComponent(`${caseName || cName}-${cPhone}-${cNum}`);
                previewQr.src = `https://api.qrserver.com/v1/create-qr-code/?size=160x160&data=${qrData}`;
                previewBarcode.src = `https://bwipjs-api.metafloor.com/?bcid=code128&text=${encodeURIComponent(cNum || caseName || cName)}&scale=2&height=50&includetext`;
        } else {
            // Standard asset preview
            const nameEl = document.getElementById('asset-name');
            const name = nameEl ? nameEl.value : '';
            const serial = serialNumber.value || '';
            const employee = employeeName.value || '';
            const locationVal = getLocationValue() || '';

            previewName.textContent = name || 'Asset Name';
            previewSerial.textContent = serial || 'N/A';
            previewEmployee.textContent = employee || 'N/A';
            previewLocation.textContent = locationVal || 'N/A';
            
            // Show standard fields in preview, hide case details
            previewSerialRow.style.display = 'block';
            previewEmployeeRow.style.display = 'block';
            previewLocationRow.style.display = 'block';
            previewCustomerDetails.style.display = 'none';

            if (name && category !== 'Not selected') {
                const qrData = encodeURIComponent(`${name}-${category}-${serial}-${employee}`);
                previewQr.src = `https://api.qrserver.com/v1/create-qr-code/?size=160x160&data=${qrData}`;
                const barcodeValue = serial || name;
                previewBarcode.src = `https://bwipjs-api.metafloor.com/?bcid=code128&text=${encodeURIComponent(barcodeValue)}&scale=2&height=50&includetext`;
            } else {
                previewQr.src = `https://api.qrserver.com/v1/create-qr-code/?size=160x160&data=Sample`;
                previewBarcode.src = `https://bwipjs-api.metafloor.com/?bcid=code128&text=Sample&scale=2&height=50&includetext`;
            }
        }
    }

    function updateDynamicFields() {
        const category = assetCategory.value;
        dynamicFields.innerHTML = '';

        // Handle Case Details category specially
        if (category === 'customer_details') {
            // Show asset name, hide standard fields
            assetNameCol.classList.remove('hidden-field');
            standardFields.style.display = 'none';
            customerDetailsSection.style.display = 'block';
            updateLocationManualVisibility();
            
            // Set case name input
            assetNameContainer.innerHTML = `<input type="text" class="form-control" id="asset-name" placeholder="Enter case name" required>`;
            const assetNameEl = document.getElementById('asset-name');
            if (assetNameEl) {
                assetNameEl.addEventListener('input', updatePreview);
                assetNameEl.addEventListener('change', updatePreview);
            }
            
            updatePreview();
            return;
        } else {
            // Show standard layout
            assetNameCol.classList.remove('hidden-field');
            standardFields.style.display = 'block';
            customerDetailsSection.style.display = 'none';
            updateLocationManualVisibility();
        }

        // Handle Asset Name field for standard categories
        if (!category) {
            assetNameContainer.innerHTML = `
                <select class="form-select" id="asset-name" disabled required>
                    <option value="">Select a category first</option>
                </select>
            `;
        } else if (category === 'employees') {
          assetNameContainer.innerHTML = `<input type="text" class="form-control" id="asset-name" placeholder="Enter employee name" required>`;
        } else if (category === 'equipments_assets') {
          assetNameContainer.innerHTML = `<input type="text" class="form-control" id="asset-name" placeholder="Enter key name" required>`;
        } else if (categoryAssets[category]) {
            let selectHTML = `<select class="form-select" id="asset-name" required>
                <option value="">Select ${category.replace(/_/g,' ')} asset</option>`;
            categoryAssets[category].forEach(name => {
                selectHTML += `<option value="${name}">${name}</option>`;
            });
            selectHTML += '</select>';
            assetNameContainer.innerHTML = selectHTML;
        } else {
            assetNameContainer.innerHTML = `<input type="text" class="form-control" id="asset-name" placeholder="Enter asset name" required>`;
        }

        // Attach listeners to the new asset-name element
        const assetNameEl = document.getElementById('asset-name');
        if (assetNameEl) {
            assetNameEl.addEventListener('input', updatePreview);
            assetNameEl.addEventListener('change', updatePreview);
        }

        // Handle Additional Details fields
        if (categoryFields[category]) {
            const fields = categoryFields[category];
            let html = '<div class="row mb-3"><div class="col-12"><h5 class="section-title">Additional Details</h5></div></div>';
            fields.forEach((f, i) => {
                if (i % 2 === 0) html += '<div class="row mb-3">';
                html += `<div class="col-md-6">
                    <label for="${f.id}" class="form-label">${f.label}</label>
                    <input type="${f.type}" class="form-control" id="${f.id}" placeholder="${f.placeholder}">
                </div>`;
                if (i % 2 === 1 || i === fields.length - 1) html += '</div>';
            });
            dynamicFields.innerHTML = html;
        }
        
        updatePreview();
    }

    assetCategory.addEventListener('change', () => {
        updateDynamicFields();
    });

    document.getElementById('clear-category').addEventListener('click', (e) => {
        e.preventDefault();
        assetCategory.value = '';
        updateDynamicFields();
    });

    assetForm.addEventListener('submit', async (e) => {
        e.preventDefault();
      if (!assetForm.reportValidity()) {
        return;
      }
        const category = assetCategory.value;
        let payload = {};

        if (category === 'customer_details') {
            // Case details payload
            const caseName = document.getElementById('asset-name').value;
            payload = {
                name: caseName, // case name
                customer_name: customerName.value,
                customer_phone: customerPhone.value,
                case_date: caseDate.value,
                case_number: caseNumber.value,
                case_type: caseType.value
            };
        } else {
            // Standard asset payload
            const name = document.getElementById('asset-name').value;
            const serial = serialNumber.value;
            const employee = employeeName.value;
            const locationVal = getLocationValue();
            
            payload = { 
                name, 
                serial_number: serial, 
                employee_name: employee, 
                location: locationVal 
            };

            if (categoryFields[category]) {
                categoryFields[category].forEach(f => {
                    const val = document.getElementById(f.id).value;
                    payload[f.id] = val;
                });
            }
        }

        try {
            const res = await fetch(`/api/assets/${category}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
                credentials: "include"
            });
          const data = await res.json();
          if (!res.ok || !data.success || !data.data) {
            throw new Error(data.error || 'Error adding asset');
          }
          if (data.success) {
                successAlert.style.display = 'block';
                setTimeout(() => successAlert.style.display = 'none', 3000);
                assetForm.reset();
                updateDynamicFields();
            } else {
                alert(data.error || 'Error adding asset');
            }
        } catch (err) {
            alert('Server error: ' + err.message);
        }
    });

    updateDynamicFields();
    updateLocationManualVisibility();
});
</script>
</body>
</html>
