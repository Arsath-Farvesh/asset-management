<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Asset Details</title>
</head>
<body>
  <h2>Asset Details</h2>
  <div id="result">Loading...</div>
  <script>
    function qs(key) {
      const params = new URLSearchParams(location.search);
      return params.get(key);
    }

    async function fetchByQR(qr) {
      try {
        // The QR in your DB is stored as a dataURL (image) if you used QRCode.toDataURL,
        // but the scanner returns the raw text (we encoded text initially), so ensure your QR match logic when creating QR codes:
        // In server.js we stored QR as image DataURL, but /api/qr tries to match that value.
        // To support scanners that produce the encoded text, you may want to save both the text and dataURL on creation (not done here).
        // This details page will first try raw code, then try searching DB for dataURL match by constructing same QR dataURL string via server lookup.
        const resp = await fetch('/api/qr/' + encodeURIComponent(qr), { credentials:'include' });
        if (!resp.ok) {
          const txt = await resp.text();
          document.getElementById('result').innerText = 'Not found: ' + txt;
          return;
        }
        const j = await resp.json();
        if (!j.success) {
          document.getElementById('result').innerText = 'Not found';
          return;
        }
        render(j);
      } catch (err) {
        document.getElementById('result').innerText = 'Error: ' + err.message;
      }
    }

    function render(payload) {
      const container = document.getElementById('result');
      const d = payload.data;
      const parts = [
        ['Category', payload.category],
        ['ID', d.id],
        ['Name', d.name || '-'],
        ['Serial', d.serial_number || '-'],
        ['Employee', d.employee_name || '-'],
        ['Location', d.location || '-'],
        ['Submitted by', d.submitted_by || '-'],
        ['Created at', new Date(d.created_at).toLocaleString()]
      ];
      container.innerHTML = '';
      parts.forEach(([label, value])=>{
        const p = document.createElement('p');
        const strong = document.createElement('strong');
        strong.textContent = label + ': ';
        p.appendChild(strong);
        p.appendChild(document.createTextNode(value));
        container.appendChild(p);
      });
      if (d.qr_code) {
        const img = document.createElement('img');
        img.src = d.qr_code;
        img.style.maxWidth = '200px';
        container.appendChild(img);
      }
      if (d.barcode) {
        const img = document.createElement('img');
        img.src = d.barcode;
        img.style.maxWidth = '200px';
        container.appendChild(img);
      }
    }

    const qr = qs('qr');
    const category = qs('category');
    const id = qs('id');

    async function fetchByCategoryId(cat, assetId) {
      try {
        const resp = await fetch(`/api/assets/${encodeURIComponent(cat)}/${encodeURIComponent(assetId)}`, { credentials:'include' });
        if (!resp.ok) throw new Error('Not found');
        const j = await resp.json();
        if (!j.success) throw new Error(j.error || 'Not found');
        render({ category: cat, data: j.data });
      } catch(err) {
        document.getElementById('result').innerText = 'Not found: ' + err.message;
      }
    }

    if (qr) {
      fetchByQR(qr);
    } else if (category && id) {
      fetchByCategoryId(category, id);
    } else {
      document.getElementById('result').innerText = 'No QR or asset reference provided.';
    }
  </script>
</body>
</html>
