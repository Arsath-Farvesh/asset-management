<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Asset Management - Input Modules</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
:root { --primary:#2c3e50; --secondary:#3498db; --accent:#e74c3c; --light:#ecf0f1; }
body { background-color:#f8f9fa; font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding:20px; }
.header { background:linear-gradient(135deg,var(--primary) 0%,var(--secondary) 100%); color:white; padding:20px; border-radius:10px; margin-bottom:30px; box-shadow:0 4px 6px rgba(0,0,0,0.1);}
.card { border-radius:10px; box-shadow:0 4px 6px rgba(0,0,0,0.1); margin-bottom:20px; border:none; transition: transform 0.3s; }
.card:hover { transform:translateY(-5px); }
.form-container { background-color:white; padding:30px; border-radius:10px; box-shadow:0 4px 6px rgba(0,0,0,0.1);}
.category-badge { background-color: var(--secondary); color:white; padding:5px 10px; border-radius:20px; font-size:0.8rem; margin-left:10px; }
.qr-barcode { max-width:200px; margin:0 auto; display:block; border:1px solid #ddd; border-radius:5px; padding:10px; background:white; }
.success-alert { display:none; position:fixed; top:20px; right:20px; z-index:1000; box-shadow:0 4px 6px rgba(0,0,0,0.1); animation:fadeIn 0.5s, fadeOut 0.5s 2.5s;}
@keyframes fadeIn { from{opacity:0;} to{opacity:1;} }
@keyframes fadeOut { from{opacity:1;} to{opacity:0;} }
.required-field::after { content:"*"; color:var(--accent); margin-left:4px; }
.section-title { border-bottom:2px solid var(--secondary); padding-bottom:10px; margin-bottom:20px; color:var(--primary);}
.navbar-custom { background-color: var(--primary); }
.navbar-custom .navbar-brand, .navbar-custom .navbar-text { color: white; }
.btn-scan { border:1px solid rgba(255,255,255,0.5); color:white; }
.btn-scan:hover { color:var(--primary); background:white; }
/* Hide asset name column when customer details selected */
.hidden-field { display: none !important; }
</style>
<link rel="stylesheet" href="theme.css">
</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-custom mb-4">
  <div class="container-fluid">
    <a class="navbar-brand fw-bold" href="#"><i class="fas fa-boxes me-2"></i>Asset Management</a>
    <div class="d-flex gap-2">
      <a href="history.html" class="btn btn-warning btn-sm">
        <i class="fas fa-history me-1"></i>History
      </a>
      <a href="qr-scan.html" class="btn btn-outline-light btn-sm btn-scan">
        <i class="fas fa-qrcode me-1"></i>Scan QR
      </a>
    </div>

    <div class="ms-auto d-flex align-items-center gap-3">
      <span id="welcomeText" class="fw-bold text-light"></span>
      <button id="logoutBtn" class="btn btn-outline-light btn-sm">Logout</button>
    </div>
  </div>
</nav>

<div class="container">
    <div class="header text-center">
        <h1><i class="fas fa-plus-circle me-2"></i>Asset Input Module</h1>
        <p class="lead">Add new assets to the management system</p>
    </div>
    <div class="row">
        <div class="col-lg-8">
            <div class="form-container card">
                <h3 class="section-title"><i class="fas fa-pencil-alt me-2"></i>Asset Details</h3>
                <form id="asset-form">
                    <div class="row mb-3">
                        <div class="col-md-6" id="asset-category-col">
                            <label for="asset-category" class="form-label required-field">Category</label>
                            <div class="input-group">
                                <select class="form-select" id="asset-category" required>
                                    <option value="">Select a category</option>
                                    <option value="assets">Assets</option>
                                    <option value="employees">Employees</option>
                                    <option value="maintenance_logs">Maintenance Logs</option>
                                    <option value="documents">Documents</option>
                                    <option value="depreciation_history">Depreciation History</option>
                                    <option value="it_hardware">IT Hardware</option>
                                    <option value="software_license">Software License</option>
                                    <option value="locations">Locations</option>
                                    <option value="machinery_equipment">Machinery & Equipment</option>
                                    <option value="digital_media">Digital Media</option>
                                    <option value="vehicles">Vehicles</option>
                                    <option value="real_estate">Real Estate</option>
                                    <option value="furniture">Furniture</option>
                                    <option value="financial_assets">Financial Assets</option>
                                    <option value="infrastructure">Infrastructure</option>
                                    <option value="tools">Tools</option>
                                    <option value="leased_assets">Leased Assets</option>
                                    <option value="equipments_assets">Equipments Assets</option>
                                    <option value="intellectual_property">Intellectual Property</option>
                                    <option value="customer_details">Customer Details</option>
                                </select>
                                <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">Options</button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" id="clear-category">Clear selection</a></li>
                                    <li><a class="dropdown-item" href="qr-scan.html">Scan QR</a></li>
                                    <li><a class="dropdown-item" href="history.html">View history</a></li>
                                </ul>
                            </div>
                        </div>
                        <div class="col-md-6" id="asset-name-col">
                            <label for="asset-name" class="form-label required-field">Asset Name</label>
                            <div id="asset-name-container">
                                <select class="form-select" id="asset-name" disabled required>
                                    <option value="">Select a category first</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Customer Details Section (shown only for customer_details) -->
                    <div id="customer-details-section" style="display: none;">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="customer-name" class="form-label required-field">Customer Name</label>
                                <input type="text" class="form-control" id="customer-name" placeholder="Enter customer name" required>
                            </div>
                            <div class="col-md-6">
                                <label for="customer-phone" class="form-label required-field">Customer Phone</label>
                                <input type="tel" class="form-control" id="customer-phone" placeholder="Enter phone number" required>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="case-date" class="form-label required-field">Date</label>
                                <input type="date" class="form-control" id="case-date" required>
                            </div>
                            <div class="col-md-6">
                                <label for="case-number" class="form-label required-field">Number of Case</label>
                                <input type="text" class="form-control" id="case-number" placeholder="Enter case number" required>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <label for="case-type" class="form-label required-field">Type of Case</label>
                                <input type="text" class="form-control" id="case-type" placeholder="Enter type of case" required>
                            </div>
                        </div>
                    </div>

                    <!-- Standard Fields (hidden for customer_details) -->
                    <div id="standard-fields">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="serial-number" class="form-label">Serial Number</label>
                                <input type="text" class="form-control" id="serial-number" placeholder="Enter serial number">
                            </div>
                            <div class="col-md-6">
                                <label for="employee-name" class="form-label">Assigned Employee</label>
                                <input type="text" class="form-control" id="employee-name" placeholder="Enter employee name">
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="asset-location" class="form-label">Location</label>
                                <input type="text" class="form-control" id="asset-location" placeholder="Enter asset location">
                            </div>
                        </div>
                    </div>
                    
                    <div id="dynamic-fields"></div>
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                        <button type="reset" class="btn btn-secondary me-md-2"><i class="fas fa-undo me-2"></i> Reset Form</button>
                        <button type="submit" class="btn btn-primary"><i class="fas fa-plus-circle me-2"></i> Add Asset</button>
                    </div>
                </form>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card">
                <div class="card-header bg-white">
                    <h5 class="card-title mb-0"><i class="fas fa-eye me-2"></i>Asset Preview</h5>
                </div>
                <div class="card-body text-center">
                    <h4 id="preview-name">Asset Name</h4>
                    <p>Category: <span id="preview-category" class="category-badge">Not selected</span></p>
                    <p id="preview-serial-row">Serial: <span id="preview-serial">N/A</span></p>
                    <p id="preview-employee-row">Employee: <span id="preview-employee">N/A</span></p>
                    <p id="preview-location-row">Location: <span id="preview-location">N/A</span></p>
                    <div id="preview-customer-details" style="display: none;">
                        <p>Customer: <span id="preview-customer-name">N/A</span></p>
                        <p>Phone: <span id="preview-customer-phone">N/A</span></p>
                        <p>Case #: <span id="preview-case-number">N/A</span></p>
                        <p>Case Type: <span id="preview-case-type">N/A</span></p>
                    </div>
                    <div class="row mt-4">
                        <div class="col-md-6">
                            <h6>QR Code</h6>
                            <img id="preview-qr" class="qr-barcode" src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=Sample">
                        </div>
                        <div class="col-md-6">
                            <h6>Barcode</h6>
                            <img id="preview-barcode" class="qr-barcode" src="https://bwipjs-api.metafloor.com/?bcid=code128&text=Sample&scale=3&height=10">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="alert alert-success success-alert" role="alert" id="success-alert">
        <i class="fas fa-check-circle me-2"></i> Asset added successfully!
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', async function() {
    // Fetch logged-in user (with cookies)
    try {
        const res = await fetch("/me", { credentials: "include" });
        const data = await res.json();
        if (data.loggedIn) {
            document.getElementById("welcomeText").textContent = `Welcome, ${data.username}`;
        } else {
            window.location.href = "/login.html";
        }
    } catch (err) {
        console.error("User fetch error:", err);
        window.location.href = "/login.html";
    }

    document.getElementById("logoutBtn").addEventListener("click", async () => {
        await fetch("/logout", { method: "POST", credentials: "include" });
        window.location.href = "/login.html";
    });

    // --- Asset form JS ---
    const assetForm = document.getElementById('asset-form');
    const assetCategory = document.getElementById('asset-category');
    const assetNameCol = document.getElementById('asset-name-col');
    const assetNameContainer = document.getElementById('asset-name-container');
    const dynamicFields = document.getElementById('dynamic-fields');
    const successAlert = document.getElementById('success-alert');
    
    // Sections
    const customerDetailsSection = document.getElementById('customer-details-section');
    const standardFields = document.getElementById('standard-fields');
    
    // Standard fields
    const serialNumber = document.getElementById('serial-number');
    const employeeName = document.getElementById('employee-name');
    const locationInput = document.getElementById('asset-location');
    
    // Customer fields
    const customerName = document.getElementById('customer-name');
    const customerPhone = document.getElementById('customer-phone');
    const caseDate = document.getElementById('case-date');
    const caseNumber = document.getElementById('case-number');
    const caseType = document.getElementById('case-type');

    // Preview elements
    const previewName = document.getElementById('preview-name');
    const previewCategory = document.getElementById('preview-category');
    const previewSerialRow = document.getElementById('preview-serial-row');
    const previewSerial = document.getElementById('preview-serial');
    const previewEmployeeRow = document.getElementById('preview-employee-row');
    const previewEmployee = document.getElementById('preview-employee');
    const previewLocationRow = document.getElementById('preview-location-row');
    const previewLocation = document.getElementById('preview-location');
    const previewCustomerDetails = document.getElementById('preview-customer-details');
    const previewCustomerName = document.getElementById('preview-customer-name');
    const previewCustomerPhone = document.getElementById('preview-customer-phone');
    const previewCaseNumber = document.getElementById('preview-case-number');
    const previewCaseType = document.getElementById('preview-case-type');
    const previewQr = document.getElementById('preview-qr');
    const previewBarcode = document.getElementById('preview-barcode');

    // Event listeners for live preview
    serialNumber.addEventListener('input', updatePreview);
    employeeName.addEventListener('input', updatePreview);
    locationInput.addEventListener('input', updatePreview);
    customerName.addEventListener('input', updatePreview);
    customerPhone.addEventListener('input', updatePreview);
    caseDate.addEventListener('input', updatePreview);
    caseNumber.addEventListener('input', updatePreview);
    caseType.addEventListener('input', updatePreview);

    const categoryAssets = {
        assets: ["Laptop","Projector","Printer","Scanner"],
        employees: ["John Doe","Jane Smith","Michael Brown"],
        maintenance_logs: ["AC Service","Generator Check","Elevator Maintenance"],
        documents: ["Invoice","Contract","Policy Document"],
        depreciation_history: ["Laptop Depreciation","Vehicle Depreciation"],
        it_hardware: ["Desktop PC","Laptop","Monitor","Keyboard","Mouse"],
        software_license: ["MS Office","Adobe Photoshop","Antivirus","ERP System"],
        locations: ["Head Office","Branch 1","Branch 2","Warehouse"],
        machinery_equipment: ["Forklift","CNC Machine","Drill Press"],
        digital_media: ["Camera","Microphone","Tripod","Lighting Kit"],
        vehicles: ["Sedan","SUV","Pickup Truck","Motorbike"],
        real_estate: ["Office Building","Warehouse","Shop"],
        furniture: ["Conference Table","Small Table","L-Shaped Table","Office Chair","Bookshelf"],
        financial_assets: ["Stocks","Bonds","Mutual Funds","Cash Reserve"],
        infrastructure: ["Server Room","Networking Equipment","Power Backup"],
        tools: ["Hammer","Screwdriver Set","Wrench","Drill"],
        equipments_assets: ["DDL","RDC","EJARI","Private Notary","Management Office","Finance Office"],
        leased_assets: ["Leased Car","Leased Printer","Leased Laptop"],
        intellectual_property: ["Patent","Trademark","Copyright"]
    };

    const categoryFields = {
        assets: [
            { type: 'date', id: 'purchase_date', label: 'Purchase Date', placeholder: '' },
            { type: 'number', id: 'value', label: 'Value ($)', placeholder: 'Enter asset value' }
        ],
        employees: [
            { type: 'text', id: 'department', label: 'Department', placeholder: 'Enter department' },
            { type: 'text', id: 'position', label: 'Position', placeholder: 'Enter job position' }
        ],
        maintenance_logs: [
            { type: 'date', id: 'maintenance_date', label: 'Maintenance Date', placeholder: '' },
            { type: 'text', id: 'technician', label: 'Technician', placeholder: 'Technician name' }
        ],
        it_hardware: [
            { type: 'text', id: 'brand', label: 'Brand', placeholder: 'Device brand' },
            { type: 'text', id: 'model', label: 'Model', placeholder: 'Device model' }
        ],
        vehicles: [
            { type: 'text', id: 'make', label: 'Make', placeholder: 'Vehicle make' },
            { type: 'text', id: 'model', label: 'Model', placeholder: 'Vehicle model' },
            { type: 'text', id: 'year', label: 'Year', placeholder: 'Manufacturing year' }
        ],
        equipments_assets: [
            { type: 'date', id: 'date', label: 'date', placeholder: 'Equip Assign Date' },
            { type: 'number', id: 'keys', label: 'Value (#)', placeholder: 'No of Quantity' }
        ]
    };

    function updatePreview() {
        const category = assetCategory.value || 'Not selected';
        previewCategory.textContent = category;

        if (category === 'customer_details') {
            // Customer details preview
            const cName = customerName.value || 'Customer Name';
            const cPhone = customerPhone.value || 'N/A';
            const cDate = caseDate.value || 'N/A';
            const cNum = caseNumber.value || 'N/A';
            const cType = caseType.value || 'N/A';
            
            previewName.textContent = cName;
            previewCustomerName.textContent = cName;
            previewCustomerPhone.textContent = cPhone;
            previewCaseNumber.textContent = cNum;
            previewCaseType.textContent = cType;
            
            // Hide standard fields in preview, show customer details
            previewSerialRow.style.display = 'none';
            previewEmployeeRow.style.display = 'none';
            previewLocationRow.style.display = 'none';
            previewCustomerDetails.style.display = 'block';
            
            // Generate QR with customer data
            const qrData = encodeURIComponent(`${cName}-${cPhone}-${cNum}`);
            previewQr.src = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${qrData}`;
            previewBarcode.src = `https://bwipjs-api.metafloor.com/?bcid=code128&text=${encodeURIComponent(cNum || cName)}&scale=3&height=10`;
        } else {
            // Standard asset preview
            const nameEl = document.getElementById('asset-name');
            const name = nameEl ? nameEl.value : '';
            const serial = serialNumber.value || '';
            const employee = employeeName.value || '';
            const locationVal = locationInput.value || '';

            previewName.textContent = name || 'Asset Name';
            previewSerial.textContent = serial || 'N/A';
            previewEmployee.textContent = employee || 'N/A';
            previewLocation.textContent = locationVal || 'N/A';
            
            // Show standard fields in preview, hide customer details
            previewSerialRow.style.display = 'block';
            previewEmployeeRow.style.display = 'block';
            previewLocationRow.style.display = 'block';
            previewCustomerDetails.style.display = 'none';

            if (name && category !== 'Not selected') {
                const qrData = encodeURIComponent(`${name}-${category}-${serial}-${employee}`);
                previewQr.src = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${qrData}`;
                const barcodeValue = serial || name;
                previewBarcode.src = `https://bwipjs-api.metafloor.com/?bcid=code128&text=${encodeURIComponent(barcodeValue)}&scale=3&height=10`;
            } else {
                previewQr.src = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=Sample`;
                previewBarcode.src = `https://bwipjs-api.metafloor.com/?bcid=code128&text=Sample&scale=3&height=10`;
            }
        }
    }

    function updateDynamicFields() {
        const category = assetCategory.value;
        dynamicFields.innerHTML = '';

        // Handle Customer Details category specially
        if (category === 'customer_details') {
            // Hide asset name column and standard fields
            assetNameCol.classList.add('hidden-field');
            standardFields.style.display = 'none';
            customerDetailsSection.style.display = 'block';
            
            // Clear dynamic fields (customer details has its own section)
            updatePreview();
            return;
        } else {
            // Show standard layout
            assetNameCol.classList.remove('hidden-field');
            standardFields.style.display = 'block';
            customerDetailsSection.style.display = 'none';
        }

        // Handle Asset Name field for standard categories
        if (!category) {
            assetNameContainer.innerHTML = `
                <select class="form-select" id="asset-name" disabled required>
                    <option value="">Select a category first</option>
                </select>
            `;
        } else if (categoryAssets[category]) {
            let selectHTML = `<select class="form-select" id="asset-name" required>
                <option value="">Select ${category.replace(/_/g,' ')} asset</option>`;
            categoryAssets[category].forEach(name => {
                selectHTML += `<option value="${name}">${name}</option>`;
            });
            selectHTML += '</select>';
            assetNameContainer.innerHTML = selectHTML;
        } else {
            assetNameContainer.innerHTML = `<input type="text" class="form-control" id="asset-name" placeholder="Enter asset name" required>`;
        }

        // Attach listeners to the new asset-name element
        const assetNameEl = document.getElementById('asset-name');
        if (assetNameEl) {
            assetNameEl.addEventListener('input', updatePreview);
            assetNameEl.addEventListener('change', updatePreview);
        }

        // Handle Additional Details fields
        if (categoryFields[category]) {
            const fields = categoryFields[category];
            let html = '<div class="row mb-3"><div class="col-12"><h5 class="section-title">Additional Details</h5></div></div>';
            fields.forEach((f, i) => {
                if (i % 2 === 0) html += '<div class="row mb-3">';
                html += `<div class="col-md-6">
                    <label for="${f.id}" class="form-label">${f.label}</label>
                    <input type="${f.type}" class="form-control" id="${f.id}" placeholder="${f.placeholder}">
                </div>`;
                if (i % 2 === 1 || i === fields.length - 1) html += '</div>';
            });
            dynamicFields.innerHTML = html;
        }
        
        updatePreview();
    }

    assetCategory.addEventListener('change', () => {
        updateDynamicFields();
    });

    document.getElementById('clear-category').addEventListener('click', (e) => {
        e.preventDefault();
        assetCategory.value = '';
        updateDynamicFields();
    });

    assetForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const category = assetCategory.value;
        let payload = {};

        if (category === 'customer_details') {
            // Customer details payload
            payload = {
                customer_name: customerName.value,
                customer_phone: customerPhone.value,
                case_date: caseDate.value,
                case_number: caseNumber.value,
                case_type: caseType.value,
                name: customerName.value // for database compatibility
            };
        } else {
            // Standard asset payload
            const name = document.getElementById('asset-name').value;
            const serial = serialNumber.value;
            const employee = employeeName.value;
            const locationVal = locationInput.value;
            
            payload = { 
                name, 
                serial_number: serial, 
                employee_name: employee, 
                location: locationVal 
            };

            if (categoryFields[category]) {
                categoryFields[category].forEach(f => {
                    const val = document.getElementById(f.id).value;
                    payload[f.id] = val;
                });
            }
        }

        try {
            const res = await fetch(`/api/assets/${category}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
                credentials: "include"
            });
            const data = await res.json();
            if (data.success) {
                successAlert.style.display = 'block';
                setTimeout(() => successAlert.style.display = 'none', 3000);
                assetForm.reset();
                updateDynamicFields();
            } else {
                alert(data.error || 'Error adding asset');
            }
        } catch (err) {
            alert('Server error: ' + err.message);
        }
    });

    updateDynamicFields();
});
</script>

</body>
</html>
